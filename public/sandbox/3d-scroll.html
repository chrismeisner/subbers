<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D TorusKnot (Single Bottom Sticky Refresh Bar)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
	/*
	  1) body.fade-in => starts with opacity-0.
	  2) Adding .loaded => transitions to opacity-100 over ~0.7s (Tailwind).
	  3) We also have a smooth background-color transition for the body (1s).
	*/
	body.fade-in {
	  @apply opacity-0 transition-opacity duration-700 ease-in-out;
	}
	body.fade-in.loaded {
	  @apply opacity-100;
	}
	/* Smooth background color transition for in-browser "refresh" */
	body {
	  transition: background-color 1s ease;
	}
  </style>
</head>

<body class="m-0 relative fade-in" onload="initPage()">
  <!-- 3D pinned background (z-10 behind everything) -->
  <div
	id="canvas-container"
	class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10"
  ></div>

  <!-- 
	Main content container: very tall (10x viewport = 1000vh)
	So user can scroll from top to bottom, rotating the TorusKnot.
	ADDED px-4 FOR MOBILE, REMOVED ON md+ (md:px-0)
  -->
  <div class="min-h-[1000vh] flex flex-col items-center justify-end px-4 md:px-0">
	<p class="text-xs mb-8 text-center text-gray-800 font-medium">
	  Have a nice day
	</p>
  </div>

  <!-- 
	BOTTOM STICKY BAR (shown on all devices):
	- "sticky bottom-0" pins it at the bottom
	- Always visible
  -->
  <div
	class="
	  sticky
	  bottom-0
	  left-0
	  w-full
	  bg-white/90
	  backdrop-blur-sm
	  z-50
	  text-center
	  py-3
	  shadow
	"
  >
	<button
	  onclick="inBrowserRefresh()"
	  class="text-sm font-semibold text-gray-800 px-5 py-2 rounded hover:text-black"
	>
	  Refresh
	</button>
  </div>

  <!-- Three.js + GSAP + ScrollTrigger from CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>

  <script>
	// 1. Generate a random #RRGGBB
	function getRandomHexColor() {
	  return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
	}

	// Convert #RRGGBB to normalized {r, g, b} in [0..1] for Three.js
	function hexToNormalizedRGB(hex) {
	  const c = new THREE.Color(hex);
	  return { r: c.r, g: c.g, b: c.b };
	}

	// 2. Globals
	let scene, camera, renderer, torusKnot;
	let originalHeight;
	let hasRenderedFirstFrame = false;

	// 3. Called on body onload
	function initPage() {
	  // Lock initial height to avoid mobile "jump"
	  originalHeight = window.innerHeight;

	  // Initial random colors
	  const bgColor = getRandomHexColor();
	  const knotColor = getRandomHexColor();

	  // Apply background color
	  document.body.style.backgroundColor = bgColor;

	  // Init Three.js with chosen knot color
	  init3D(knotColor);
	}

	// 4. Initialize Three.js Scene
	function init3D(knotColor) {
	  scene = new THREE.Scene();

	  camera = new THREE.PerspectiveCamera(
		60,
		window.innerWidth / originalHeight, // locked height ratio
		0.1,
		1000
	  );
	  camera.position.set(0, 0, 3);

	  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
	  renderer.setSize(window.innerWidth, originalHeight);
	  document.getElementById('canvas-container').appendChild(renderer.domElement);

	  // Basic lighting
	  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
	  scene.add(ambientLight);

	  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
	  directionalLight.position.set(5, 5, 5);
	  scene.add(directionalLight);

	  // TorusKnot geometry: radius=0.5, tube=0.225, seg=256, radSeg=64, p=2, q=3
	  const geometry = new THREE.TorusKnotGeometry(0.5, 0.225, 256, 64, 2, 3);

	  // Lambert for bright color
	  const material = new THREE.MeshLambertMaterial({
		color: knotColor
	  });

	  torusKnot = new THREE.Mesh(geometry, material);
	  scene.add(torusKnot);

	  // Start render loop
	  animate();

	  // Scroll-based rotation
	  initScrollTrigger();

	  // Listen for width changes only
	  window.addEventListener('resize', onWindowResize);
	}

	// 5. Animation loop (fade-in on first frame)
	function animate() {
	  requestAnimationFrame(animate);

	  if (!hasRenderedFirstFrame) {
		document.body.classList.add('loaded');
		hasRenderedFirstFrame = true;
	  }

	  renderer.render(scene, camera);
	}

	// 6. ScrollTrigger for rotating the knot as user scrolls
	function initScrollTrigger() {
	  gsap.registerPlugin(ScrollTrigger);

	  gsap.to(torusKnot.rotation, {
		x: 2 * Math.PI,
		y: 2 * Math.PI,
		scrollTrigger: {
		  trigger: document.body,
		  start: 'top top',
		  end: 'bottom top',
		  scrub: 1
		}
	  });
	}

	// 7. Width-only resize (no vertical resize to avoid "jump" on mobile)
	function onWindowResize() {
	  const newWidth = window.innerWidth;
	  renderer.setSize(newWidth, originalHeight);
	  camera.aspect = newWidth / originalHeight;
	  camera.updateProjectionMatrix();
	}

	// 8. In-Browser "Refresh" => smoothly change colors
	function inBrowserRefresh() {
	  // a) New background color
	  const newBGColor = getRandomHexColor();
	  document.body.style.backgroundColor = newBGColor;

	  // b) New knot color
	  const newKnotColor = getRandomHexColor();

	  // Smoothly tween the knot color via GSAP
	  if (torusKnot) {
		const oldRGB = {
		  r: torusKnot.material.color.r,
		  g: torusKnot.material.color.g,
		  b: torusKnot.material.color.b
		};
		const targetRGB = hexToNormalizedRGB(newKnotColor);

		gsap.to(oldRGB, {
		  duration: 1,
		  r: targetRGB.r,
		  g: targetRGB.g,
		  b: targetRGB.b,
		  onUpdate: () => {
			torusKnot.material.color.setRGB(oldRGB.r, oldRGB.g, oldRGB.b);
		  }
		});
	  }

	  console.log("Refresh -> BG:", newBGColor, "| Knot:", newKnotColor);
	}
  </script>
</body>
</html>
