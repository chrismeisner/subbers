<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D TorusKnot (In-Browser “Refresh”)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
	/*
	  FADE-IN SEQUENCE:
	  1) body.fade-in => starts with opacity-0.
	  2) Adding .loaded => transitions to opacity-100 over ~0.7s.
	*/
	body.fade-in {
	  @apply opacity-0 transition-opacity duration-700 ease-in-out;
	}
	body.fade-in.loaded {
	  @apply opacity-100;
	}
  </style>
</head>

<body class="m-0 relative fade-in" onload="initPage()">
  <!-- Pinned 3D background -->
  <div id="canvas-container" class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10"></div>

  <!-- Sticky header with "Refresh" button that changes colors in-browser -->
  <header class="sticky top-0 bg-white/90 backdrop-blur-sm z-50 w-full text-center py-2 shadow">
	<button 
	  onclick="inBrowserRefresh()" 
	  class="text-xs font-semibold text-gray-800 px-4 py-2 rounded hover:text-black"
	>
	  Refresh
	</button>
  </header>

  <!-- Tall container to allow scrolling and reveal bottom message -->
  <div class="min-h-[200vh] flex flex-col items-center justify-end">
	<!-- Bottom message -->
	<p class="text-xs mb-8 text-center text-gray-800 font-medium">
	  Have a nice day
	</p>
  </div>

  <!-- Three.js and GSAP + ScrollTrigger from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>

  <script>
	// ------------------------------------------------------------------------
	// 1. Random Color Generator
	// ------------------------------------------------------------------------
	function getRandomHexColor() {
	  return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
	}

	// ------------------------------------------------------------------------
	// 2. Globals
	// ------------------------------------------------------------------------
	let scene, camera, renderer, torusKnot;
	let originalHeight;            // locked height
	let hasRenderedFirstFrame = false;

	// ------------------------------------------------------------------------
	// 3. Page Initialization (onload)
	// ------------------------------------------------------------------------
	function initPage() {
	  // Lock the initial height so mobile doesn’t “jump”
	  originalHeight = window.innerHeight;

	  // Generate initial random colors
	  const bgColor = getRandomHexColor();
	  const knotColor = getRandomHexColor();

	  // Apply background color
	  document.body.style.backgroundColor = bgColor;

	  // Init Three.js
	  init3D(knotColor);
	}

	// ------------------------------------------------------------------------
	// 4. Initialize Three.js Scene
	// ------------------------------------------------------------------------
	function init3D(knotColor) {
	  scene = new THREE.Scene();

	  camera = new THREE.PerspectiveCamera(
		60,
		window.innerWidth / originalHeight, // Lock height
		0.1,
		1000
	  );
	  camera.position.set(0, 0, 3);

	  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
	  renderer.setSize(window.innerWidth, originalHeight);
	  document.getElementById('canvas-container').appendChild(renderer.domElement);

	  // Basic lighting
	  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
	  scene.add(ambientLight);

	  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
	  directionalLight.position.set(5, 5, 5);
	  scene.add(directionalLight);

	  // TorusKnot geometry
	  // radius=0.5, tube=0.225, segments=256, radialSegments=64, p=2, q=3
	  const geometry = new THREE.TorusKnotGeometry(0.5, 0.225, 256, 64, 2, 3);
	  // Use Lambert for bright color
	  const material = new THREE.MeshLambertMaterial({
		color: knotColor
	  });

	  torusKnot = new THREE.Mesh(geometry, material);
	  scene.add(torusKnot);

	  // Start the render loop
	  animate();

	  // Set up scroll-based rotation
	  initScrollTrigger();

	  // Listen for width changes only
	  window.addEventListener('resize', onWindowResize);
	}

	// ------------------------------------------------------------------------
	// 5. Render Loop (fade-in on first frame)
	// ------------------------------------------------------------------------
	function animate() {
	  requestAnimationFrame(animate);

	  if (!hasRenderedFirstFrame) {
		document.body.classList.add('loaded');
		hasRenderedFirstFrame = true;
	  }

	  renderer.render(scene, camera);
	}

	// ------------------------------------------------------------------------
	// 6. ScrollTrigger for Rotation
	// ------------------------------------------------------------------------
	function initScrollTrigger() {
	  gsap.registerPlugin(ScrollTrigger);

	  gsap.to(torusKnot.rotation, {
		x: 2 * Math.PI,
		y: 2 * Math.PI,
		scrollTrigger: {
		  trigger: document.body,
		  start: 'top top',
		  end: 'bottom top',
		  scrub: 1
		}
	  });
	}

	// ------------------------------------------------------------------------
	// 7. Width-Only Resize
	// ------------------------------------------------------------------------
	function onWindowResize() {
	  const newWidth = window.innerWidth;
	  renderer.setSize(newWidth, originalHeight);
	  camera.aspect = newWidth / originalHeight;
	  camera.updateProjectionMatrix();
	}

	// ------------------------------------------------------------------------
	// 8. In-Browser "Refresh" Function
	// ------------------------------------------------------------------------
	function inBrowserRefresh() {
	  // a) Pick a new random background
	  const newBG = getRandomHexColor();
	  document.body.style.backgroundColor = newBG;

	  // b) Pick a new random knot color
	  const newKnotColor = getRandomHexColor();
	  if (torusKnot) {
		// This updates the TorusKnot’s color live
		torusKnot.material.color.set(newKnotColor);
	  }

	  console.log("In-Browser Refresh -> BG:", newBG, "| Knot:", newKnotColor);
	}
  </script>
</body>
</html>
