<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D TorusKnot (Smooth Color Fade)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
	/*
	  1) Body fade-in on initial load:
		 body.fade-in => starts with opacity-0.
		 Then .loaded => transitions to opacity-100 over 0.7s.
	  2) Smooth background color transition:
		 body => transitions background-color over 1s ease.
	*/
	body.fade-in {
	  @apply opacity-0 transition-opacity duration-700 ease-in-out;
	}
	body.fade-in.loaded {
	  @apply opacity-100;
	}
	/* Smooth background-color transition */
	body {
	  transition: background-color 1s ease;
	}
  </style>
</head>

<body class="m-0 relative fade-in" onload="initPage()">
  <!-- Pinned Three.js background -->
  <div id="canvas-container" class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10"></div>

  <!-- Sticky header with "Refresh" button -->
  <header class="sticky top-0 bg-white/90 backdrop-blur-sm z-50 w-full text-center py-2 shadow">
	<button 
	  onclick="inBrowserRefresh()" 
	  class="text-xs font-semibold text-gray-800 px-4 py-2 rounded hover:text-black"
	>
	  Refresh
	</button>
  </header>

  <!-- Tall container to allow scrolling and reveal bottom message -->
  <div class="min-h-[200vh] flex flex-col items-center justify-end">
	<!-- Bottom message -->
	<p class="text-xs mb-8 text-center text-gray-800 font-medium">
	  Have a nice day
	</p>
  </div>

  <!-- Three.js and GSAP + ScrollTrigger from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>

  <script>
	// ------------------------------------------------------------------------
	// 1. HELPER: Random #RRGGBB color
	// ------------------------------------------------------------------------
	function getRandomHexColor() {
	  return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
	}

	// Converts a hex color (#RRGGBB) to {r, g, b} in 0..1 range for Three.js
	function hexToNormalizedRGB(hex) {
	  const c = new THREE.Color(hex);
	  return { r: c.r, g: c.g, b: c.b };  // c.r, c.g, c.b are already 0..1
	}

	// ------------------------------------------------------------------------
	// 2. GLOBALS
	// ------------------------------------------------------------------------
	let scene, camera, renderer, torusKnot;
	let originalHeight;            
	let hasRenderedFirstFrame = false;

	// ------------------------------------------------------------------------
	// 3. PAGE INIT (onload)
	// ------------------------------------------------------------------------
	function initPage() {
	  // Lock initial height
	  originalHeight = window.innerHeight;

	  // Pick random colors
	  const bgColor = getRandomHexColor();
	  const knotColor = getRandomHexColor();

	  // Apply background color (will fade in from CSS if page isn't loaded yet)
	  document.body.style.backgroundColor = bgColor;

	  // Init Three.js with the chosen knot color
	  init3D(knotColor);
	}

	// ------------------------------------------------------------------------
	// 4. INIT THREE.JS
	// ------------------------------------------------------------------------
	function init3D(knotColor) {
	  scene = new THREE.Scene();

	  camera = new THREE.PerspectiveCamera(60, window.innerWidth / originalHeight, 0.1, 1000);
	  camera.position.set(0, 0, 3);

	  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
	  renderer.setSize(window.innerWidth, originalHeight);
	  document.getElementById('canvas-container').appendChild(renderer.domElement);

	  // Lights
	  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
	  scene.add(ambientLight);

	  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
	  directionalLight.position.set(5, 5, 5);
	  scene.add(directionalLight);

	  // TorusKnot geometry
	  const geometry = new THREE.TorusKnotGeometry(0.5, 0.225, 256, 64, 2, 3);
	  const material = new THREE.MeshLambertMaterial({
		color: knotColor
	  });

	  torusKnot = new THREE.Mesh(geometry, material);
	  scene.add(torusKnot);

	  // Start render loop
	  animate();

	  // Setup scroll-trigger rotation
	  initScrollTrigger();

	  // Listen for width changes only
	  window.addEventListener('resize', onWindowResize);
	}

	// ------------------------------------------------------------------------
	// 5. RENDER LOOP (FADE-IN ON FIRST FRAME)
	// ------------------------------------------------------------------------
	function animate() {
	  requestAnimationFrame(animate);

	  if (!hasRenderedFirstFrame) {
		document.body.classList.add('loaded');
		hasRenderedFirstFrame = true;
	  }

	  renderer.render(scene, camera);
	}

	// ------------------------------------------------------------------------
	// 6. SCROLLTRIGGER for rotating the knot
	// ------------------------------------------------------------------------
	function initScrollTrigger() {
	  gsap.registerPlugin(ScrollTrigger);
	  gsap.to(torusKnot.rotation, {
		x: 2 * Math.PI,
		y: 2 * Math.PI,
		scrollTrigger: {
		  trigger: document.body,
		  start: 'top top',
		  end: 'bottom top',
		  scrub: 1
		}
	  });
	}

	// ------------------------------------------------------------------------
	// 7. WIDTH-ONLY RESIZE
	// ------------------------------------------------------------------------
	function onWindowResize() {
	  const newWidth = window.innerWidth;
	  renderer.setSize(newWidth, originalHeight);
	  camera.aspect = newWidth / originalHeight;
	  camera.updateProjectionMatrix();
	}

	// ------------------------------------------------------------------------
	// 8. IN-BROWSER REFRESH WITH FADE
	// ------------------------------------------------------------------------
	function inBrowserRefresh() {
	  // a) Generate new background color
	  const newBGColor = getRandomHexColor();

	  // b) Generate new knot color
	  const newKnotColor = getRandomHexColor();

	  // c) Apply background color with 1s CSS transition (already set in <style>)
	  document.body.style.backgroundColor = newBGColor;

	  // d) Smoothly tween the TorusKnot color using GSAP
	  if (torusKnot) {
		// 1. Get current color in normalized [0,1]
		const oldRGB = {
		  r: torusKnot.material.color.r,
		  g: torusKnot.material.color.g,
		  b: torusKnot.material.color.b
		};

		// 2. Convert newKnotColor (#RRGGBB) to normalized [0,1]
		const targetRGB = hexToNormalizedRGB(newKnotColor);

		// 3. GSAP tween from oldRGB -> targetRGB
		gsap.to(oldRGB, {
		  duration: 1,
		  r: targetRGB.r,
		  g: targetRGB.g,
		  b: targetRGB.b,
		  onUpdate: () => {
			// Update the material color each tick
			torusKnot.material.color.setRGB(oldRGB.r, oldRGB.g, oldRGB.b);
		  }
		});
	  }

	  console.log("In-Browser Refresh -> BG:", newBGColor, "| Knot:", newKnotColor);
	}
  </script>
</body>
</html>
