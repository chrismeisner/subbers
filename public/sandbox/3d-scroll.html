<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D TorusKnot (Scrolling Refresh Button)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
	/*
	  We'll rely on Tailwind classes plus a small custom fade-in sequence:
	  1) body.fade-in => starts with opacity-0.
	  2) We add .loaded => transitions to opacity-100 over 0.7s.
	*/
	body.fade-in {
	  @apply opacity-0 transition-opacity duration-700 ease-in-out;
	}
	body.fade-in.loaded {
	  @apply opacity-100;
	}
  </style>
</head>

<body class="m-0 relative fade-in" onload="setRandomColorsAndInit()">

  <!-- Pinned Three.js background -->
  <div id="canvas-container" class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10"></div>

  <!-- 
	A tall container to allow scrolling (200vh or more).
	The Refresh button is inside this normal flow container,
	so it scrolls with the page rather than staying fixed.
  -->
  <div class="min-h-[200vh] relative w-full">
	
	<!-- Centered Refresh button (not fixed) -->
	<div class="pt-12 flex justify-center z-10">
	  <a
		href="#"
		onclick="window.location.reload()"
		class="bg-white bg-opacity-90 px-4 py-2 text-xl font-semibold text-gray-800 rounded shadow hover:text-black"
	  >
		Refresh
	  </a>
	</div>
	
  </div>

  <!-- Three.js and GSAP + ScrollTrigger from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>

  <script>
	// 1. Generate a random #RRGGBB color string
	function getRandomHexColor() {
	  return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
	}

	// 2. Globals
	let scene, camera, renderer, torusKnot;
	let chosenKnotColor;
	let hasRenderedFirstFrame = false;  // for fade-in logic
	let originalHeight;                 // locked height at load

	// 3. Called on body onload
	function setRandomColorsAndInit() {
	  // Random background color
	  const randomBGColor = getRandomHexColor();
	  document.body.style.backgroundColor = randomBGColor;

	  // Random knot color
	  chosenKnotColor = getRandomHexColor();

	  console.log("Random BG Color:", randomBGColor);
	  console.log("Random Knot Color:", chosenKnotColor);

	  // Lock the initial height
	  originalHeight = window.innerHeight;

	  // Initialize 3D
	  init3D();
	}

	// 4. Init Three.js scene
	function init3D() {
	  scene = new THREE.Scene();

	  camera = new THREE.PerspectiveCamera(
		60,
		window.innerWidth / originalHeight, // lock the height
		0.1,
		1000
	  );
	  camera.position.set(0, 0, 3);

	  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
	  renderer.setSize(window.innerWidth, originalHeight);
	  document.getElementById('canvas-container').appendChild(renderer.domElement);

	  // Basic lighting
	  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
	  scene.add(ambientLight);

	  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
	  directionalLight.position.set(5, 5, 5);
	  scene.add(directionalLight);

	  // More complex TorusKnot geometry
	  // radius=0.5, tube=0.225, tubularSegments=256, radialSegments=64, p=2, q=3
	  const geometry = new THREE.TorusKnotGeometry(0.5, 0.225, 256, 64, 2, 3);

	  // Use Lambert so random colors look bright
	  const material = new THREE.MeshLambertMaterial({
		color: chosenKnotColor
	  });

	  torusKnot = new THREE.Mesh(geometry, material);
	  scene.add(torusKnot);

	  // Start render loop
	  animate();

	  // Setup scroll-trigger rotation
	  initScrollTrigger();

	  // Listen for width changes only
	  window.addEventListener('resize', onWindowResize);
	}

	// 5. Render loop (fade-in on first frame)
	function animate() {
	  requestAnimationFrame(animate);

	  if (!hasRenderedFirstFrame) {
		document.body.classList.add('loaded');
		hasRenderedFirstFrame = true;
	  }

	  renderer.render(scene, camera);
	}

	// 6. ScrollTrigger to rotate the knot
	function initScrollTrigger() {
	  gsap.registerPlugin(ScrollTrigger);

	  gsap.to(torusKnot.rotation, {
		x: 2 * Math.PI,
		y: 2 * Math.PI,
		scrollTrigger: {
		  trigger: document.body,
		  start: 'top top',
		  end: 'bottom top',
		  scrub: 1
		}
	  });
	}

	// 7. Width-only resize
	function onWindowResize() {
	  const newWidth = window.innerWidth;

	  // Keep the renderer's height fixed
	  renderer.setSize(newWidth, originalHeight);

	  camera.aspect = newWidth / originalHeight;
	  camera.updateProjectionMatrix();
	}
  </script>
</body>
</html>
